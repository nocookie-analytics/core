name: Python application

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest
    container: tiangolo/docker-with-compose

    env:
      DOMAIN: backend
      SMTP_HOST: ""
      TRAEFIK_PUBLIC_NETWORK_IS_EXTERNAL: false
      INSTALL_DEV: true



    steps:
    - uses: actions/checkout@v2

    - uses: whoan/docker-build-with-cache-action@v5
      with:
        username: ${{ github.repository_owner }}
        password: "${{ secrets.GITHUB_TOKEN }}"
        registry: docker.pkg.github.com
        context: backend
        image_name: nca-backend

    - name: Setup env file
      run: |
        mv .env-ci .env

    - name: Create docker stack
      run: |
        docker-compose \
        -f docker-compose.yml \
        config > docker-stack.yml

    - name: DEBUG
      run: |
        docker image ls

    - name: Build docker images
      run: |
        docker-compose -f docker-stack.yml build --parallel

    - name: Start docker
      run: |
        docker-compose -f docker-stack.yml up -d

    - name: Run tests
      run: |
        docker-compose -f docker-stack.yml exec -T backend bash /app/tests-start.sh "$@"
